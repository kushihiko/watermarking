# Watermarking DLP - Система внедрения меток в текст

Проект для внедрения невидимых меток (watermarks) в PDF-документы с целью определения источника утечки информации. При фотографировании или сканировании документа система может идентифицировать, кто получил доступ к документу, путем извлечения внедренной метки.

## Описание

Система использует OCR (Optical Character Recognition) для анализа текста на изображениях, определения позиций слов, и внедряет метки путем незначительного сдвига позиций слов. Метки кодируются с использованием алгоритма bit stuffing для обеспечения надежности извлечения даже при частичной потере данных.

## Возможности

- **Внедрение меток**: Автоматическое внедрение уникальных идентификаторов в PDF-документы
- **Извлечение меток**: Восстановление меток из отсканированных или сфотографированных документов
- **Работа с PDF**: Прямая работа с PDF-файлами без необходимости ручной конвертации
- **Точное позиционирование**: Определение bounding boxes для слов с помощью OCR
- **Bit Stuffing**: Надежное кодирование меток с защитой от ошибок
- **Два парсера**: Поддержка Tesseract OCR и OpenCV для различных сценариев
- **Гибкая конфигурация**: Настройка через YAML-файлы

## Архитектура

Проект построен на модульной архитектуре:

- **`pkg/bitset`** - Работа с битовыми наборами для представления меток
- **`pkg/bitstuffing`** - Кодирование меток с использованием bit stuffing алгоритма
- **`pkg/shifter`** - Сдвиг позиций слов для кодирования битов метки
- **`pkg/parser`** - Парсеры OCR (Tesseract и GoCV) для определения позиций слов
- **`pkg/converter`** - Конвертация PDF в изображения и обратно
- **`pkg/painter`** - Отрисовка и перестановка слов на изображениях
- **`internal/usecase`** - Бизнес-логика внедрения и извлечения меток
- **`internal/config`** - Загрузка и валидация конфигурации

## Требования

- Go 1.24 или выше
- ImageMagick (для работы с PDF)
- OpenCV (опционально, для GoCV парсера)
- Tesseract OCR (опционально, для Tesseract парсера)

### Установка зависимостей

**macOS:**
```bash
# ImageMagick
brew install imagemagick

# OpenCV (для GoCV парсера)
brew install opencv

# Tesseract OCR (опционально)
brew install tesseract
brew install tesseract-lang
```

**Linux (Ubuntu/Debian):**
```bash
# ImageMagick
sudo apt-get install libmagickwand-dev

# OpenCV (для GoCV парсера)
sudo apt-get install libopencv-dev

# Tesseract OCR (опционально)
sudo apt-get install tesseract-ocr
sudo apt-get install tesseract-ocr-rus
```

## Установка

1. Клонируйте репозиторий:
```bash
git clone <repository-url>
cd watermarking
```

2. Установите зависимости Go:
```bash
go mod download
```

3. Убедитесь, что ImageMagick установлен:
```bash
convert --version
```

## Использование

### Основной CLI инструмент

Основной инструмент для работы с метками находится в `cmd/watermark_cli/`.

#### Внедрение метки

```bash
cd cmd/watermark_cli
go run main.go embed --config=config.yaml --storage=0 --event=123
```

Где:
- `--config` - путь к YAML конфигурационному файлу
- `--storage` - идентификатор места хранения событий
- `--event` - идентификатор события (будет внедрен как метка)

#### Извлечение метки

```bash
cd cmd/watermark_cli
go run main.go extract --config=config.yaml
```

Результат: выводится числовое значение извлеченной метки.

### Конфигурационный файл

Пример `config.yaml`:

```yaml
embed:
  pdf_src: "test.pdf"                    # Исходный PDF файл
  pdf_dst: "doc_with_watermarking.pdf"   # PDF с внедренной меткой
  print_boxes: false                      # Отрисовывать bounding boxes (для отладки)
  shift: 4                                # Величина сдвига в пикселях для кодирования бита
  marker_length: 8                        # Длина маркера для bit stuffing

extract:
  pdf_src: "doc_with_watermarking.pdf"   # PDF для извлечения метки

tmp_folder: "tmp/"                       # Временная папка для изображений
output_pattern: "image-%d.png"            # Шаблон имени временных файлов
output_folder: "output/"                 # Папка для выходных файлов
```

## Структура проекта

```
watermarking/
├── cmd/
│   ├── watermark_cli/     # Основной CLI инструмент
│   ├── experiment/        # Экспериментальные модули
│   ├── generate/          # Генерация тестовых документов
│   ├── test1/             # Тесты восстановления из HOCR
│   ├── test2/             # Тесты работы с OCR
│   ├── test2_2/           # Тесты работы с PDF
│   ├── test2_3/           # Дополнительные тесты
│   └── test3/             # Тесты работы с изображениями
├── internal/
│   ├── config/            # Конфигурация
│   └── usecase/           # Бизнес-логика
├── pkg/
│   ├── bitset/            # Битовые наборы
│   ├── bitstuffing/       # Bit stuffing кодирование
│   ├── converter/         # PDF ↔ Изображения
│   ├── painter/           # Отрисовка и перестановка
│   ├── parser/            # Парсеры OCR
│   │   ├── gocv/          # OpenCV парсер
│   │   └── tesseract/     # Tesseract парсер
│   ├── shifter/           # Сдвиг позиций для кодирования
│   └── tsv/               # Парсер TSV формата
├── test/                  # Тестовые данные
├── go.mod
└── README.md
```

## Принцип работы

### Внедрение метки

1. **Конвертация PDF в изображения**: PDF-документ конвертируется в серию изображений
2. **OCR анализ**: Для каждого изображения определяется позиция каждого слова
3. **Нормализация**: Позиции слов нормализуются (выравниваются пробелы)
4. **Кодирование метки**: Метка кодируется с использованием bit stuffing
5. **Сдвиг позиций**: Позиции слов сдвигаются в зависимости от битов метки
6. **Перерисовка**: Изображение перерисовывается с новыми позициями слов
7. **Сборка PDF**: Изображения собираются обратно в PDF

### Извлечение метки

1. **Конвертация PDF в изображения**: PDF-документ конвертируется в изображения
2. **OCR анализ**: Определяются позиции слов на изображениях
3. **Декодирование**: Анализируются промежутки между словами для определения битов
4. **Восстановление**: Используется алгоритм голосования для восстановления метки из нескольких страниц
5. **Декодирование bit stuffing**: Удаляются вставленные биты
6. **Возврат метки**: Возвращается числовое значение метки

## Основные компоненты

### BitSet (`pkg/bitset`)

Работа с битовыми наборами для представления меток.

```go
bset := bitset.NewBitSet(32)
bset.Set(0)  // Установить бит
bset.Get(0)  // Получить бит
```

### BitStuffing (`pkg/bitstuffing`)

Кодирование меток с использованием bit stuffing для защиты от ошибок.

```go
bstuff, _ := bitstuffing.NewBitStuffing(8)  // marker_length = 8
encoded, _ := bstuff.PrepareMark(123)       // Кодирование метки
decoded, _ := bstuff.Decode(encoded)         // Декодирование
```

### Shifter (`pkg/shifter`)

Сдвиг позиций слов для кодирования битов метки.

```go
shft := shifter.NewShifter(4)  // сдвиг = 4 пикселя
shft.Normalize(boxes)          // Нормализация позиций
shft.Encrypt(boxes, bits)      // Кодирование битов
bits, confs := shft.Decrypt(boxes)  // Декодирование
```

### Parser (`pkg/parser`)

Два типа парсеров для определения позиций слов:

#### GoCV Parser
Использует OpenCV для определения контуров символов и группировки их в слова.

```go
prs := gocvparser.NewParser(10)  // minArea = 10
boxes, _ := prs.Image("image.png")
```

#### Tesseract Parser
Использует Tesseract OCR для распознавания текста и получения координат.

```go
prs := tesseract.NewParser("rus", gosseract.RIL_WORD)
boxes, _ := prs.Image("image.png")
```

### Converter (`pkg/converter`)

Конвертация между PDF и изображениями с использованием ImageMagick.

```go
conv := converter.NewConverter(0, 0, 0, 0)
imgs, _ := conv.PDFToImage("document.pdf")
conv.ImagesToPDF(imagePaths, "output.pdf")
```

### Painter (`pkg/painter`)

Отрисовка и перестановка слов на изображениях.

```go
pnt := painter.NewPainter(width, height, false)
newImg, _ := pnt.Rearrange(oldImg, oldBoxes, newBoxes, words)
```

## Зависимости

Основные зависимости:

- `gopkg.in/yaml.v3` - Работа с YAML конфигурацией
- `gopkg.in/gographics/imagick.v3` - ImageMagick обертка для работы с PDF
- `gocv.io/x/gocv` - OpenCV для Go (для GoCV парсера)
- `github.com/otiai10/gosseract/v2` - Tesseract OCR обертка (для Tesseract парсера)
- `github.com/fogleman/gg` - Графическая библиотека для отрисовки
- `github.com/signintech/gopdf` - Работа с PDF

## Применение для DLP

### Workflow использования

1. **Подготовка документа**: Загрузите PDF-документ в систему
2. **Внедрение метки**: Используйте уникальный идентификатор (например, ID пользователя или события)
3. **Распределение**: Распределите помеченные документы среди пользователей
4. **Мониторинг**: При обнаружении утечки - извлеките метку из документа
5. **Идентификация**: Определите источник утечки по значению метки

## Параметры настройки

### Shift (сдвиг)

Величина сдвига в пикселях, на которую перемещается слово для кодирования бита "1". Рекомендуемые значения: 2-6 пикселей.

- **Меньше значение**: Менее заметно, но сложнее извлечь
- **Больше значение**: Легче извлечь, но может быть заметно

### Marker Length

Длина маркера для bit stuffing. Рекомендуемые значения: 5-10.

- **Короче маркер**: Меньше накладных расходов, но выше вероятность ложных срабатываний
- **Длиннее маркер**: Надежнее, но больше накладных расходов


## Ограничения

- Система работает лучше с документами, содержащими текст (не изображения)
- Качество извлечения зависит от качества OCR
- При сильном искажении документа (размытие, поворот) извлечение может быть неточным
- Рекомендуется использовать документы с четким текстом и достаточным количеством слов